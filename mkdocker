#!/bin/bash
#
# This builds and runs a microservice.
#

set -e

. build/version.properties

# Only use --pull option of docker build if we have internet connectivity
#   (otherwise docker build will fail)
if ping -q -c1 inomial.io >/dev/null 2>&1; then
  online_docker_args="--pull"
else
  online_docker_args=""
fi

cp build/libs/$SERVICE-$version.jar docker
pushd docker
if [ -f ../build/libs/$SERVICE-$version-grow.jar ]
then
  rm -rf GROW
  jar xf ../build/libs/$SERVICE-$version-grow.jar GROW
else
  # Keep Dockerfile happy
  mkdir -p GROW
fi
docker build $online_docker_args -t inomial.io/$SERVICE --build-arg version=$version --build-arg SERVICE=$SERVICE .
popd
